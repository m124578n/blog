<!DOCTYPE html><html class="appearance-auto" lang="ch"><head><meta charset="UTF-8"><title>Git CICD with Docker</title><meta name="description" content="自我實現 自我成長！"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="/blog/style/common/bulma.css"><link rel="stylesheet" href="/blog/style/base.css"><link rel="stylesheet" href="/blog/style/common/helper.css"><script src="/blog/js/common.js"></script><link rel="stylesheet" href="/blog/style/post.css"><link rel="stylesheet" href="/blog/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/blog/style/common/jquery.fancybox.min.css"><script src="/blog/js/highlight.pack.js"></script><meta name="description" content="image docker-logo
前言：這個主題是在水球軟體學院中舉辦的Docker共學會最終回的成果發表文章，本人我也是第一次寫文章，主要目的應該會著重在自己的一個紀錄，內容如果不是那麼正確還請多多包容和指點以下正篇。

正篇：Docker是一個容器化服務，他可以在一台電腦中切出好幾個環境分別執行不同的任務。
這邊會進行一個簡單的web server然後執行Github actions 或 Gitlab CICD達成自動化測試以及自動化部署。
稍後將會介紹到的項目有以下幾樣：

Dockerfile

docker-compose.yml

github&amp;#x2F;workflows 中的yml檔



首先最基本的要架設一個網站會需要的服務為web server和database。
那們我將會以Pyt.."><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/blog/atom.xml" title="Shun Chih's blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/blog/">Shun Chih's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Git CICD with Docker</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">返回頂部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/blog/">首頁</a></h3><h3 class="is-inline-block"><a href="/blog/about">關於我</a></h3><h3 class="is-inline-block"><a href="/blog/archives">文章列表</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/blog/">首頁</a></h3><h3 class="is-inline-block"><a href="/blog/about">關於我</a></h3><h3 class="is-inline-block"><a href="/blog/archives">文章列表</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%EF%BC%9A"><span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AD%A3%E7%AF%87%EF%BC%9A"><span class="toc-text">正篇：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A6%96%E5%85%88"><span class="toc-text">首先</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B3%87%E6%96%99%E5%A4%BE%E9%9A%8E%E5%B1%A4%E6%9C%83%E9%95%B7%E9%80%99%E6%A8%A3"><span class="toc-text">資料夾階層會長這樣</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%99%E6%98%AFDjango%E4%B9%9F%E5%B0%B1%E6%98%AFweb%E8%A3%A1%E9%9D%A2%E7%9A%84Dockerfile"><span class="toc-text">這是Django也就是web裡面的Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E4%BE%86%E6%98%AFnginx%E8%A3%A1%E9%9D%A2%E7%9A%84Dockerfile"><span class="toc-text">再來是nginx裡面的Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%84%B6%E5%BE%8C%E6%98%AF%E6%A0%B9%E7%9B%AE%E9%8C%84%E4%B8%8B%E7%9A%84docker-compose-yml"><span class="toc-text">然後是根目錄下的docker-compose.yml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Github-actions"><span class="toc-text">Github actions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E5%80%91%E5%88%B0Github%E7%9A%84%E9%A0%81%E9%9D%A2%E9%BB%9E%E9%81%B8Actions"><span class="toc-text">我們到Github的頁面點選Actions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%9E%E9%81%B8%E4%B8%8B%E6%96%B9%E7%9A%84Configure%E5%B0%B1%E6%9C%83%E5%85%88%E5%B9%AB%E4%BD%A0%E5%BB%BA%E7%AB%8B%E4%B8%80%E5%80%8B%E9%A0%90%E8%A8%AD%E7%9A%84yml"><span class="toc-text">點選下方的Configure就會先幫你建立一個預設的yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E4%B8%8B%E4%BE%86%E6%98%AF%E6%B8%AC%E8%A9%A6%E9%80%9A%E9%81%8E%E5%BE%8C%E8%A6%81%E6%8A%8A%E9%80%99%E6%95%B4%E5%8C%85%E9%83%A8%E7%BD%B2%E5%88%B0%E4%BD%A0%E6%8C%87%E5%AE%9A%E7%9A%84%E4%BD%8D%E7%BD%AE%E4%B8%8A%E4%B9%9F%E5%B0%B1%E6%98%AFCD%E7%9A%84%E9%83%A8%E5%88%86"><span class="toc-text">接下來是測試通過後要把這整包部署到你指定的位置上也就是CD的部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Settings"><span class="toc-text">Settings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Secrets-and-variables"><span class="toc-text">Secrets and variables</span></a></li></ol></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/blog/tags/github%20actions"><i class="tag post-item-tag">github actions</i></a><a href="/blog/tags/docker"><i class="tag post-item-tag">docker</i></a><a href="/blog/tags/%E6%B0%B4%E7%90%83%E8%BB%9F%E9%AB%94%E5%AD%B8%E9%99%A2"><i class="tag post-item-tag">水球軟體學院</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Git CICD with Docker</h1><time class="has-text-grey" datetime="2023-03-18T12:00:00.000Z">2023-03-18</time><article class="mt-2 post-content"><p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_bZP17SmwRZihfAYDr5KBFg.webp"><br><em>image <a target="_blank" rel="noopener" href="https://1000logos.net/docker-logo/">docker-logo</a></em></p>
<h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>這個主題是在水球軟體學院中舉辦的Docker共學會最終回的成果發表文章，本人我也是第一次寫文章，主要目的應該會著重在自己的一個紀錄，內容如果不是那麼正確還請多多包容和指點以下正篇。</p>
<hr>
<h1 id="正篇："><a href="#正篇：" class="headerlink" title="正篇："></a>正篇：</h1><p>Docker是一個容器化服務，他可以在一台電腦中切出好幾個環境分別執行不同的任務。</p>
<p>這邊會進行一個簡單的web server然後執行Github actions 或 Gitlab CICD達成自動化測試以及自動化部署。</p>
<p>稍後將會介紹到的項目有以下幾樣：</p>
<ul>
<li><p>Dockerfile</p>
</li>
<li><p>docker-compose.yml</p>
</li>
<li><p>github&#x2F;workflows 中的yml檔</p>
</li>
</ul>
<hr>
<h2 id="首先"><a href="#首先" class="headerlink" title="首先"></a>首先</h2><p>最基本的要架設一個網站會需要的服務為web server和database。</p>
<p>那們我將會以Python Django串接Nginx做為web server那database是使用Django預設的sqlite簡單演示。</p>
<h3 id="資料夾階層會長這樣"><a href="#資料夾階層會長這樣" class="headerlink" title="資料夾階層會長這樣"></a>資料夾階層會長這樣</h3><pre><code class="hljs bash">+根目錄
|
+-+nginx/
|      |
|      +--Dockerfile
|      +--docker-nginx-web.conf
|      +--nginx.conf
+-+web/
|     |
|     +--Dockerfile
|     +--requirements.txt
|     +-+app/以下略
|
+--docker-compose.yml</code></pre>

<h3 id="這是Django也就是web裡面的Dockerfile"><a href="#這是Django也就是web裡面的Dockerfile" class="headerlink" title="這是Django也就是web裡面的Dockerfile"></a>這是Django也就是web裡面的Dockerfile</h3><pre><code class="hljs bash">FROM python:3.8.5
LABEL maintainer=<span class="hljs-string">&quot;xxxx@gmail.com&quot;</span>

WORKDIR /web
COPY . /web/

RUN pip install --upgrade pip 
RUN pip install -r requirements.txt

WORKDIR /web/app

VOLUME /web

EXPOSE 8001</code></pre>

<h3 id="再來是nginx裡面的Dockerfile"><a href="#再來是nginx裡面的Dockerfile" class="headerlink" title="再來是nginx裡面的Dockerfile"></a>再來是nginx裡面的Dockerfile</h3><pre><code class="hljs bash">FROM nginx:latest
LABEL maintainer=<span class="hljs-string">&quot;xxxx@gmail.com&quot;</span>


COPY nginx.conf /etc/nginx/nginx.conf
COPY docker-nginx-web.conf /etc/nginx/sites-available/

RUN <span class="hljs-built_in">mkdir</span> -p /etc/nginx/sites-enabled/ &amp;&amp; \
    <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/docker-nginx-web.conf /etc/nginx/sites-enabled/

CMD [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]</code></pre>

<h3 id="然後是根目錄下的docker-compose-yml"><a href="#然後是根目錄下的docker-compose-yml" class="headerlink" title="然後是根目錄下的docker-compose.yml"></a>然後是根目錄下的docker-compose.yml</h3><pre><code class="hljs bash">version: <span class="hljs-string">&#x27;3.8&#x27;</span>

services:
        app_web:
                build: ./web
                container_name: app_web
                restart: always
                <span class="hljs-built_in">command</span>: [<span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;uwsgi --ini uwsgi.ini&quot;</span>]
                volumes:
                        - web_data:/web/app
                ports:
                        - <span class="hljs-string">&quot;8001:8001&quot;</span>
                environment:
                        - PYTHONUNBUFFERED=TURE
        app_nginx:
                build: ./nginx
                container_name: app_nginx
                restart: always
                volumes:
                        - web_data:/web/app
                ports:
                        - <span class="hljs-string">&quot;80:80&quot;</span>
                depends_on:
                        - app_web
volumes:
        web_data:</code></pre>

<p>那我們這邊docker-compose.yml裡面的build會去找尋web和nginx目錄下的Dockerfile並根據Dockerfile的內容去啟動container。</p>
<p>這邊下指令</p>
<pre><code class="hljs bash">docker-compose up --build -d</code></pre>

<p>其實就會直接把兩個container建立起來了。</p>
<hr>
<h2 id="Github-actions"><a href="#Github-actions" class="headerlink" title="Github actions"></a>Github actions</h2><p>然後就可以開始寫Github actions的yml檔囉！</p>
<h3 id="我們到Github的頁面點選Actions"><a href="#我們到Github的頁面點選Actions" class="headerlink" title="我們到Github的頁面點選Actions"></a>我們到Github的頁面點選Actions</h3><p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_NEBsJwswssn2VffDuNyVSg.webp"></p>
<h3 id="點選下方的Configure就會先幫你建立一個預設的yml"><a href="#點選下方的Configure就會先幫你建立一個預設的yml" class="headerlink" title="點選下方的Configure就會先幫你建立一個預設的yml"></a>點選下方的Configure就會先幫你建立一個預設的yml</h3><p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_eT-ez4_d77qUFV54NycBig.webp"></p>
<p>這邊就可以開始編輯自己的yml檔，但是Github上也有很多已經編輯好的yml檔會出現在Configure下方可以選用。</p>
<p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_Zk9WR4svGoxlIuGd59R8gw.webp"></p>
<p>那這邊我就先用預設的yml來編輯</p>
<p>那預設的yml呢它上面會有很詳細的註解說明每一個指令的功用，這邊只截取我需要的部分把它改寫成這樣</p>
<pre><code class="hljs bash">name: Django CI

on:
  push:
    branches: [ <span class="hljs-string">&quot;main&quot;</span> ]
  pull_request:
    branches: [ <span class="hljs-string">&quot;main&quot;</span> ]

<span class="hljs-built_in">jobs</span>:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python <span class="hljs-variable">$&#123;&#123; matrix.python-version &#125;</span>&#125;
      uses: actions/setup-python@v3
      with:
        python-version: <span class="hljs-variable">$&#123;&#123; matrix.python-version &#125;</span>&#125;
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r web/requirements.txt
    - name: Run Tests
      run: |
        python  web/app/manage.py <span class="hljs-built_in">test</span></code></pre>

<p>這邊是當你對這個repositories有push或是pull_request的時候就會觸發job的程序，上面那邊有$NaN是我們可以對他執行多個版本的測試，這邊我只有跑一個python 3.8，那我們看到最後一行，這個就只是在跑Django的測試內容。</p>
<h3 id="接下來是測試通過後要把這整包部署到你指定的位置上也就是CD的部分"><a href="#接下來是測試通過後要把這整包部署到你指定的位置上也就是CD的部分" class="headerlink" title="接下來是測試通過後要把這整包部署到你指定的位置上也就是CD的部分"></a>接下來是測試通過後要把這整包部署到你指定的位置上也就是CD的部分</h3><pre><code class="hljs bash">name: Django CD
<span class="hljs-comment"># 只有在 CI 的 workflow 完成時才會執行此 workflow</span>
<span class="hljs-comment"># https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run</span>
on:
  workflow_run:
    workflows: [ Django CI ]
    types:
      - completed

<span class="hljs-built_in">jobs</span>:
  deploy:
    runs-on: ubuntu-latest

    <span class="hljs-comment"># 注意前面 workflow_run 的 completed 意思是「完成」，不論執行結果成功或是失敗都算是「完成」</span>
    <span class="hljs-comment"># 但是一般來說測試如果失敗就應該暫停部屬至正式環境</span>
    <span class="hljs-comment"># 因此這裡加上一個 if 判斷，只有 CI 成功才會執行此 workflow</span>
    <span class="hljs-comment"># https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run</span>
    <span class="hljs-keyword">if</span>: <span class="hljs-variable">$&#123;&#123; github.event.workflow_run.conclusion == &#x27;success&#x27; &#125;</span>&#125;
    
    steps:
      <span class="hljs-comment"># 使用 appleboy/ssh-action@master 這個 action 遠端連線至正式環境</span>
      <span class="hljs-comment"># https://github.com/appleboy/ssh-action</span>
      - name: Deployment
        uses: appleboy/ssh-action@master
        with:
          host: <span class="hljs-variable">$&#123;&#123; secrets.HOST &#125;</span>&#125;
          key: <span class="hljs-variable">$&#123;&#123; secrets.TOKEN &#125;</span>&#125;
          username: ec2-user
          <span class="hljs-comment"># 執行部屬的指令</span>
          <span class="hljs-comment">#docker rmi -f $(docker images -q  -f dangling=true)</span>
          <span class="hljs-comment">#docker volume rm $(docker volume ls -q -f dangling=true)</span>
          script: | 
            <span class="hljs-built_in">whoami</span>
        
            sudo yum -y install docker
            sudo yum -y install git 
            sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(<span class="hljs-built_in">uname</span> -s)-$(<span class="hljs-built_in">uname</span> -m) -o /usr/local/bin/docker-compose
            sudo <span class="hljs-built_in">chmod</span> 777 /usr/local/bin/docker-compose
            docker-compose version
            <span class="hljs-built_in">cd</span> ~
            sudo <span class="hljs-built_in">rm</span> -fr *
            sudo git <span class="hljs-built_in">clone</span> https://github.com/xxx/testCICD.git
            <span class="hljs-built_in">cd</span> testCICD
            sudo systemctl restart docker
            sudo <span class="hljs-built_in">chmod</span> 777 /var/run/docker.sock
            docker-compose down
            docker rmi -f $(docker images -q  -f dangling=<span class="hljs-literal">true</span>)
            docker volume <span class="hljs-built_in">rm</span> $(docker volume <span class="hljs-built_in">ls</span> -q -f dangling=<span class="hljs-literal">true</span>)
            docker-compose up --build -d</code></pre>

<p>這邊我是參考了appleboy的ssh-action，這樣就可以透過ssh的方式連接到你的機器裡做上面所寫好的script了，那上面有兩個地方應該會有問題就是host跟key那兩個變數的新增位置在Settings</p>
<h3 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h3><p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_8Wz_y3La0uRxRcdfkytSvA.webp"></p>
<h3 id="Secrets-and-variables"><a href="#Secrets-and-variables" class="headerlink" title="Secrets and variables"></a>Secrets and variables</h3><p>裡面的Security點開Secrets and variables中的Actions</p>
<p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_PC6h-Bnv3I5Ow5j0U4NbRQ.webp"></p>
<p>你會看到</p>
<p><img src="/blog/images/2023-03-18Git_CICD_with_Docker/1_y0993aLDo40RPOChDZMQkw.webp"></p>
<p>這邊就可以管理你在Github actions中的任何密鑰以及變數。</p>
<p>這邊這個CICD最終會部署到我在AWS EC2中架設的一個小機器裡面，裡頭還有很多細節也有很多我還沒搞清楚的地方，之後有機會在拆分主題來一一探討。</p>
<hr>
<p>最後，我是一個轉職的工程師，目前剛轉滿半年多一點，還在努力學習中，如果有任何問題或建議都可以私訊我<a href="mailto:&#x6d;&#50;&#51;&#x35;&#x36;&#x38;&#x6e;&#64;&#103;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#x6d;&#50;&#51;&#x35;&#x36;&#x38;&#x6e;&#64;&#103;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;</a>，我也常在 <a target="_blank" rel="noopener" href="https://discord.gg/waterballsa">水球軟體學院</a> 活動，歡迎大家一起加入這個大社群一起學習一起進步！！</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/blog/2023/04/12/2023-04-12%E5%88%9D%E6%8E%A2%E5%BA%97%E5%AE%B6%E6%9C%83%E5%93%A1%E7%B6%B2%E7%AB%99%E8%A8%AD%E8%A8%88/" title="初探店家會員網站設計"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一頁: 初探店家會員網站設計</span></a></section><article class="mt-6 comment-container"><script async repo="m124578n/blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/m124578n"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/m23568n"><i class="iconfont icon-ins"></i></a><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/blog/atom.xml"><i class="iconfont icon-rss"></i></a><!-- 知乎--><!-- 领英--><a title="linkedin" target="_blank" rel="noopener nofollow" href="//www.linkedin.com/in/john19980215"><i class="iconfont icon-linkedin"></i></a><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com/m23568n"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Shun Chih 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/blog/js/jquery-3.6.1.min.js"></script><script src="/blog/js/jquery-fancybox.min.js"></script><script src="/blog/js/img_zoom.js"></script><script src="/blog/js/post.js"></script></body></html>