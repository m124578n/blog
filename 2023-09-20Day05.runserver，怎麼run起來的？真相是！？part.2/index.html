<!DOCTYPE html><html class="appearance-auto" lang="ch"><head><meta charset="UTF-8"><title>Day05. runserver，怎麼run起來的？真相是！？part.2</title><meta name="description" content="自我實現 自我成長！"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="/blog/style/common/bulma.css"><link rel="stylesheet" href="/blog/style/base.css"><link rel="stylesheet" href="/blog/style/common/helper.css"><script src="/blog/js/common.js"></script><link rel="stylesheet" href="/blog/style/post.css"><link rel="stylesheet" href="/blog/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/blog/style/common/jquery.fancybox.min.css"><script src="/blog/js/highlight.pack.js"></script><meta name="description" content="前言接續上回，我們終於走到了感覺像真的要把server run起來的地方了！畢竟function名稱都直接叫run了！那今天我們就繼續挖，挖到底看到底會長怎麼樣吧！！
正題接續上集的圖，今天會集中在這張圖～

昨天我們到了run()的階段，讓我們來看看～

那這邊會流向使用reloader因為我們python manage.py runserver並沒有要求他不要啟動autoreloader

我挖

這邊會看到幾個重點（路徑為django.utils.autoreload.py）

signal
get_reloader()
start_django()

我們一個一個看signal先來他怎麼來的呢，往上看會發現

是內建函式庫呢，看來直接google比較快～python的官方文件簡單的理解大概是當pyt.."><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/blog/atom.xml" title="Shun Chih's blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/blog/">Shun Chih's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Day05. runserver，怎麼run起來的？真相是！？part.2</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">返回頂部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/blog/">首頁</a></h3><h3 class="is-inline-block"><a href="/blog/about">關於我</a></h3><h3 class="is-inline-block"><a href="/blog/archives">文章列表</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/blog/">首頁</a></h3><h3 class="is-inline-block"><a href="/blog/about">關於我</a></h3><h3 class="is-inline-block"><a href="/blog/archives">文章列表</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E9%A1%8C"><span class="toc-text">正題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B5%90%E8%AA%9E"><span class="toc-text">結語</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/blog/tags/django"><i class="tag post-item-tag">django</i></a><a href="/blog/tags/python"><i class="tag post-item-tag">python</i></a><a href="/blog/tags/15th%E9%90%B5%E4%BA%BA%E8%B3%BD"><i class="tag post-item-tag">15th鐵人賽</i></a><a href="/blog/tags/source%20code"><i class="tag post-item-tag">source code</i></a><a href="/blog/tags/web%20framework"><i class="tag post-item-tag">web framework</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Day05. runserver，怎麼run起來的？真相是！？part.2</h1><time class="has-text-grey" datetime="2023-09-20T14:38:13.000Z">2023-09-20</time><article class="mt-2 post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>接續上回，我們終於走到了感覺像真的要把server run起來的地方了！畢竟function名稱都直接叫run了！<br>那今天我們就繼續挖，挖到底看到底會長怎麼樣吧！！</p>
<h2 id="正題"><a href="#正題" class="headerlink" title="正題"></a>正題</h2><p>接續上集的圖，今天會集中在這張圖～</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/201629056iZD7Q4rHe.png"></p>
<p>昨天我們到了<code>run()</code>的階段，讓我們來看看～</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905Zvp3tUbsR4.png"></p>
<p>那這邊會流向使用<code>reloader</code>因為我們<code>python manage.py runserver</code>並沒有要求他不要啟動autoreloader</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905jUSwhKy1TW.png"></p>
<p>我挖</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905NlHu5hFgub.png"></p>
<p>這邊會看到幾個重點（路徑為<code>django.utils.autoreload.py</code>）</p>
<ul>
<li><code>signal</code></li>
<li><code>get_reloader()</code></li>
<li><code>start_django()</code></li>
</ul>
<p>我們一個一個看<br><code>signal</code>先來<br>他怎麼來的呢，往上看會發現</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905s20cMGne5f.png"></p>
<p>是內建函式庫呢，看來直接google比較快～<br><a target="_blank" rel="noopener" href="https://docs.python.org/zh-tw/3/library/signal.html">python的官方文件</a><br>簡單的理解大概是當python接收到訊號<code>signal.SIGTERM</code>會去執行後面的<code>lambda</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905l8yEutMyHj.png"></p>
<p>而<code>lambda</code>中的<code>sys.exit(0)</code>則是讓這支程序退出</p>
<p>接下來是<br><code>get_reloader()</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905rp2gBzZ1IP.png"></p>
<p>這邊會看到兩條路<code>WatchmanReloader</code>和<code>StatReloader</code>，兩個都是會去紀錄並關心Django的健康狀況，之後看有沒有機會來說明，今天的重點依舊是<code>runserver</code></p>
<p>最後是<br><code>start_django()</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905d6jxXe6aNA.png"></p>
<p>這邊可以看到Django額外開了一個thread是for main_func的，至於thread是什麼呢？可能還會提到process，網路上有很多詳細的資料可以查閱這邊就不獻醜了<br>我們回過頭來看<code>main_func</code>是什麼呢？</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905jUSwhKy1TW.png"></p>
<p>哦～是在進去<code>autoreload</code>之前的<code>runserver</code>裡面的function啊～<br>那這個<code>self.inner_run</code>做了哪些事情呢？<br>我們直接來看重點！</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/201629059Mtp7dLi6K.png"></p>
<p>這邊兩個重點</p>
<ul>
<li><code>get_handler()</code></li>
<li><code>run()</code></li>
</ul>
<p>首先<br><code>get_handler()</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/201629050kLwRZ9ypz.png"></p>
<p>再挖</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905cdwTOrHyMF.png"></p>
<p>這邊我們可以看到他會去拿我們<code>startproject</code>後生出來的<code>wsgi.py</code><br>我挖<code>wsgi.py</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/201629050iwhce5Wnd.png"></p>
<p>我再挖<code>get_wsgi_application()</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/201629058X9IUoDKS2.png"></p>
<p>這邊可以看到<code>django.setup()</code>然後<code>return WSGIHandler()</code>，這兩個坑之後會補起來的！<br>至此我們可以知道<code>get_handler()</code>會<code>return WSGIHandler()</code></p>
<p>接下來換<br><code>run()</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/201629052JQP8Ccpxi.png"></p>
<p>關鍵字來</p>
<ul>
<li>WSGIServer</li>
<li>WSGIRequestHandler</li>
<li>set_app()</li>
<li>serve_forever()</li>
</ul>
<p><code>WSGIServer</code>和<code>WSGIRequestHandler</code></p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905IezZtR1oNn.png"></p>
<p>這邊我們看關鍵字<code>simple_server</code>就好了（<code>WSGIRequestHandler</code>也是去繼承<code>simple_server</code>的類別）</p>
<p><img src="/blog/images/2023-09-20Day05.runserver%EF%BC%8C%E6%80%8E%E9%BA%BCrun%E8%B5%B7%E4%BE%86%E7%9A%84%EF%BC%9F%E7%9C%9F%E7%9B%B8%E6%98%AF%EF%BC%81%EF%BC%9Fpart.2/20162905xnARHcAcO8.png"></p>
<p>摁～<code>wsgiref</code>也是個python的內建函式庫<br>上<a target="_blank" rel="noopener" href="https://docs.python.org/zh-tw/3/library/wsgiref.html">官方文件</a>可以看到有提供簡單的起一個server的範例<br>而<code>wsgiref</code>的範例中就可以看到<code>set_app()</code>和<code>serve_forever()</code>的身影～</p>
<p>至此大概的流程就走到這邊，而<code>python manage.py runserver</code>最後就是由<code>wsgiref</code>啟動的！</p>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>其實當中還是有很多地方可以去深探，但我這邊就是講一個菜鳥看源碼的感覺，可以看到平常使用的<code>python manage.py runserver</code>到底做了多少事情，可以說越挖越深，但挖的越深我越開心呀！</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/blog/2023-12-02%E9%A6%96%E6%AC%A1%EF%BC%8C%E5%87%BA%E5%9C%8B%EF%BC%8C%E6%97%A5%E6%9C%AC%E8%A1%8C%EF%BC%81%EF%BC%81/" title="首次，出國，日本行！！"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一頁: 首次，出國，日本行！！</span></a><a class="button is-default" href="/blog/2023-09-19Day04.%E6%89%80%E4%BB%A5%E8%AA%AArunserver%EF%BC%8C%E9%98%BFserver%E6%80%8E%E9%BA%BCrun%E7%9A%84%EF%BC%81%EF%BC%9Fpart.1/" title="Day04. 所以說runserver，阿server怎麼run的！？part.1"><span class="has-text-weight-semibold">下一頁: Day04. 所以說runserver，阿server怎麼run的！？part.1</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="m124578n/blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/m124578n"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/m23568n"><i class="iconfont icon-ins"></i></a><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/blog/atom.xml"><i class="iconfont icon-rss"></i></a><!-- 知乎--><!-- 领英--><a title="linkedin" target="_blank" rel="noopener nofollow" href="//www.linkedin.com/in/john19980215"><i class="iconfont icon-linkedin"></i></a><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com/m23568n"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Shun Chih 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/blog/js/jquery-3.6.1.min.js"></script><script src="/blog/js/jquery-fancybox.min.js"></script><script src="/blog/js/img_zoom.js"></script><script src="/blog/js/post.js"></script></body></html>