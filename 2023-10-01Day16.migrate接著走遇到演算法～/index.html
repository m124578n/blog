<!DOCTYPE html><html class="appearance-auto" lang="ch"><head><meta charset="UTF-8"><title>Day16. migrate 接著走遇到演算法～</title><meta name="description" content="自我實現 自我成長！"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="前言昨天我們看到了django中的migrations是用graph的方式去存取，在造graph的時候也跑了一些function去驗證graph的一些特性，那～今天我們就繼續往下看看migrate接下來的過程吧！​
正題
executor init後會跑一個去驗證graph和migration的一致性接下來會去檢查衝突

他會去檢查graph中的葉節點是否有重複

有的話就會報錯～接著往下會去看python manage.py migrate的時候有沒有其他的參數，那我這邊都沒給參數所以會是這個

會把所有葉節點指向targets接著中間有一段也是檢查有無而外參數，我們跳過到這邊

生出一個migration plan


其中大部分都會流向

而當中的forwards_plan呢又做了什麼事

會去把該t.."><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Shun Chih's blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Shun Chih's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Day16. migrate 接著走遇到演算法～</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">返回頂部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首頁</a></h3><h3 class="is-inline-block"><a href="/about">關於我</a></h3><h3 class="is-inline-block"><a href="/archives">文章列表</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首頁</a></h3><h3 class="is-inline-block"><a href="/about">關於我</a></h3><h3 class="is-inline-block"><a href="/archives">文章列表</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E9%A1%8C"><span class="toc-text">正題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B5%90%E8%AA%9E"><span class="toc-text">結語</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/django"><i class="tag post-item-tag">django</i></a><a href="/tags/python"><i class="tag post-item-tag">python</i></a><a href="/tags/15th%E9%90%B5%E4%BA%BA%E8%B3%BD"><i class="tag post-item-tag">15th鐵人賽</i></a><a href="/tags/source%20code"><i class="tag post-item-tag">source code</i></a><a href="/tags/web%20framework"><i class="tag post-item-tag">web framework</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Day16. migrate 接著走遇到演算法～</h1><time class="has-text-grey" datetime="2023-10-01T10:47:49.000Z">2023-10-01</time><article class="mt-2 post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>昨天我們看到了django中的migrations是用graph的方式去存取，在造graph的時候也跑了一些function去驗證graph的一些特性，那～今天我們就繼續往下看看migrate接下來的過程吧！<br>​</p>
<h2 id="正題"><a href="#正題" class="headerlink" title="正題"></a>正題</h2><p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905OlrkWIaXjv.png"></p>
<p>executor init後會跑一個去驗證graph和migration的一致性<br>接下來會去檢查衝突</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905FQa3IYUDmJ.png"></p>
<p>他會去檢查graph中的葉節點是否有重複</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905lsZ8vAI14b.png"></p>
<p>有的話就會報錯～<br>接著往下會去看<code>python manage.py migrate</code>的時候有沒有其他的參數，那我這邊都沒給參數所以會是這個</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905SsjguOHDlf.png"></p>
<p>會把所有葉節點指向targets<br>接著中間有一段也是檢查有無而外參數，我們跳過到<br>這邊</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/201629052wZJBK8ccI.png"></p>
<p>生出一個migration plan</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905lZEtSLn5yh.png"></p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905orr0Q1ZV1h.png"></p>
<p>其中大部分都會流向</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905RSlLCMQxFz.png"></p>
<p>而當中的forwards_plan呢又做了什麼事</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/201629051zZHcUTZl7.png"></p>
<p>會去把該target相關依賴依據DFS深度優先搜尋找出來</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905HHANV8Y8Qb.png"></p>
<p>把相關不存在applied的migration都加到plan中<br>接著往下</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905ZS7gdFPIYG.png"></p>
<p>這邊我們先跳過，因為我還沒搞清楚ＸＤ，他有pre和post都會丟signal給db，明天好好研究！<br>但<code>_create_project_state</code>先來看看</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/2016290513LLxj0BLr.png"></p>
<p>這邊先記錄一下，不太清楚<code>migration.mutate_state()</code>這一段在做什麼！？<br>再往下</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905XmHPlFSnb7.png"></p>
<p>其中<code>MigrationAutodetector</code>會去比較兩邊的<code>ProjectState</code></p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905NmwPLVK9Fc.png"></p>
<p>看看兩邊有無改變，如果有會說明要如何解決～</p>
<p><img src="/images/2023-10-01Day16.migrate%E6%8E%A5%E8%91%97%E8%B5%B0%E9%81%87%E5%88%B0%E6%BC%94%E7%AE%97%E6%B3%95%EF%BD%9E/20162905gg5ngixhx3.png"></p>
<p>最後會才會進入migrate，不過今天就先到這邊吧！剩下的我們明天繼續！<br>​</p>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>今天這樣看著看著當中有些地方看一兩遍其實還是沒有很清楚，需要再花一點時間去了解整體架構和一些python的lib用法！<br>尚未了解事項：</p>
<ul>
<li>signal</li>
<li>migration.mutate_state<br>​<br>之後再找時間補起來！</li>
</ul>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023-10-02Day17.migrate%E7%99%BC%E9%80%81%E4%BA%86%E4%BF%A1%E8%99%9Fsignal%EF%BC%81%EF%BC%9F/" title="Day17. migrate發送了信號signal！？"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一頁: Day17. migrate發送了信號signal！？</span></a><a class="button is-default" href="/2023-09-30Day15.django%E4%B8%AD%E7%9A%84graph%EF%BC%81/" title="Day15. django中的graph！"><span class="has-text-weight-semibold">下一頁: Day15. django中的graph！</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="m124578n/blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/m124578n"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/m23568n"><i class="iconfont icon-ins"></i></a><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml"><i class="iconfont icon-rss"></i></a><!-- 知乎--><!-- 领英--><a title="linkedin" target="_blank" rel="noopener nofollow" href="//www.linkedin.com/in/john19980215"><i class="iconfont icon-linkedin"></i></a><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com/m23568n"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Shun Chih 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>